language: php

sudo: false

cache:
    directories:
        - vendor
        - $HOME/.composer/cache/files
        - $HOME/.build

matrix:
    include:
        - php: 5.3
          dist: precise
        - php: 5.4
        - php: 5.5
        - php: 5.6
        - php: 7.0
        - php: 7.1
        - php: 7.2
        - php: 7.3
          env: SYMFONY_PHPUNIT_VERSION=7.2 ICU_VERSION=63.1
        - php: nightly
    allow_failures:
        - php: nightly
    fast_finish: true

before_install:
    - INI=~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini
    - echo memory_limit = -1 >> $INI
    - echo session.gc_probability = 0 >> $INI
    - echo apc.enable_cli = 1 >> $INI
    - phpenv config-rm xdebug.ini || echo "xdebug not available"
    - if [[ $TRAVIS_PHP_VERSION = 5.* ]]; then echo yes | pecl install -f apcu-4.0.11; fi
    - if [[ $TRAVIS_PHP_VERSION = 7.* ]]; then echo yes | pecl install -f apcu_bc-1.0.4; fi
    - if [[ $TRAVIS_PHP_VERSION = 7.* ]]; then echo yes | pecl install -f apcu-5.1.11; fi
    - |
        if [[ $ICU_VERSION ]]; then
            ICU_DIR=$HOME/.build/icu-$ICU_VERSION
            ICU_PHP_VERSION=$(php -r "echo PHP_VERSION;")
            ICU_PHP_DIR=$HOME/.build/php-$ICU_PHP_VERSION-icu-$ICU_VERSION
            export ICU_PHP=$ICU_PHP_DIR/bin/php
            if [ ! -f $ICU_PHP ]; then
                wget -O icu-src.tgz http://download.icu-project.org/files/icu4c/$ICU_VERSION/icu4c-$(echo $ICU_VERSION | tr '.' '_')-src.tgz
                mkdir icu-src && tar xzf icu-src.tgz -C icu-src --strip-components=1
                pushd icu-src/source
                    ./configure --prefix=$ICU_DIR
                    make && make install
                popd
                wget -O php-src.tgz http://us1.php.net/get/php-$ICU_PHP_VERSION.tar.gz/from/this/mirror
                mkdir php-src && tar xzf php-src.tgz -C php-src --strip-components=1
                pushd php-src
                    ./configure --prefix=$ICU_PHP_DIR --enable-intl --with-icu-dir=$ICU_DIR
                    make && make install
                popd
            fi
            $ICU_PHP -r "echo INTL_ICU_VERSION.PHP_EOL;"
            $ICU_PHP -r "var_dump((new ReflectionClass('Normalizer'))->getConstants());"
        fi
    - php -i

install:
    - if [[ $TRAVIS_BRANCH = master ]]; then export COMPOSER_ROOT_VERSION=dev-master; else export COMPOSER_ROOT_VERSION=$TRAVIS_BRANCH.x-dev; fi
    - composer --prefer-source install

script:
    - ./vendor/bin/simple-phpunit
    - if [[ $ICU_PHP ]]; then $ICU_PHP ./vendor/bin/simple-phpunit --filter 'Symfony\\Polyfill\\Tests\\Intl'; fi
